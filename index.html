
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PsiSearch ‚Ä¢ Single File (v0.6.5)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --bg-dark: #0b1220; --bg-dark-2: #0f172a; --bg-dark-3: #0b1328;
      --border-dark: rgba(148,163,184,.25);
      --ink-1: #e7eefc; --ink-2: #c7d4ef; --ink-3: #9fb0cf;
      --accent: #7c83ff; --success:#18c08d; --danger:#ff5a5a;
      --chip: rgba(148,163,184,.12); --chip-border: rgba(148,163,184,.28);
      --input: #0e1a33; --input-border: rgba(148,163,184,.45);
      --shadow: 0 8px 24px rgba(0,0,0,.35);
    }
    html.dark body { background: radial-gradient(1200px 800px at 20% -10%, #11193a 0%, var(--bg-dark) 60%) fixed; }
    html.dark header { background: linear-gradient(180deg, var(--bg-dark-3) 0%, rgba(11,18,32,.75) 100%) !important; }
    html.dark .bg-white\/70, html.dark .bg-white\/60, html.dark .bg-white { background-color: var(--bg-dark-2) !important; }
    html.dark .border-gray-100 { border-color: var(--border-dark) !important; }
    html.dark .text-gray-900 { color: var(--ink-1) !important; }
    html.dark .text-gray-700, html.dark .text-gray-600 { color: var(--ink-2) !important; }
    html.dark .text-gray-500 { color: var(--ink-3) !important; }

    /* Inputs com texto branco */
    html.dark input[type="text"],
    html.dark input[type="search"],
    html.dark input[type="number"],
    html.dark select,
    html.dark textarea {
      background: var(--input) !important;
      border: 1px solid var(--input-border) !important;
      color: #ffffff !important;
      -webkit-text-fill-color: #ffffff !important;
      caret-color: #ffffff !important;
      box-shadow: var(--shadow);
    }
    html.dark #q { color:#fff !important; -webkit-text-fill-color:#fff !important; }
    html.dark input::placeholder { color: #cfd9f2 !important; opacity: .85; }

    /* Result titles leg√≠veis */
    html.dark #results h3 { color: #fff !important; opacity: 1 !important; }

    /* Labels (idioma + p√∫blico) com mais contraste */
    html.dark #popFilters label,
    html.dark #langFilters label { color: #fff !important; }

    /* Chips / bot√µes */
    html.dark .inline-flex.items-center.rounded-full.border {
      background: var(--chip) !important;
      border-color: var(--chip-border) !important;
      color: var(--ink-2) !important;
    }
    html.dark #btnTheme { background: #0d1832 !important; color: var(--ink-1) !important; border-color: var(--input-border) !important; }

    @media print { header, aside, footer { display: none !important; } main { display:block; margin:0; padding:0; } .rounded-3xl{ break-inside: avoid; } }
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .8rem; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-size:.75rem; }
    .btn-solid { display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .8rem; border-radius:999px; background:#4f46e5; color:#fff; font-size:.75rem; }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-emerald-50">
  <header class="sticky top-0 z-10 backdrop-blur bg-white/60 border-b border-gray-100">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="flex h-10 w-10 items-center justify-center rounded-2xl bg-indigo-600 text-white shadow">Œ®</div>
        <div class="leading-tight">
          <div class="text-sm font-semibold text-gray-900">PsiSearch</div>
          <div class="text-[11px] text-gray-500">Single-file ‚Ä¢ v0.6.5</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnTheme" class="rounded-2xl bg-white text-gray-700 border border-gray-200 px-3 py-1.5 text-xs">üåô Modo escuro</button>
      </div>
    </div>
    <div class="mx-auto max-w-6xl px-4 pb-3 -mt-2 grid grid-cols-3 gap-2">
      <div class="rounded-2xl border border-gray-100 bg-white/70 px-3 py-2 text-xs text-gray-700 flex items-center justify-between">
        <span>Crossref</span><span id="h_crossref" class="px-2 py-0.5 rounded-full bg-gray-100">checando‚Ä¶</span>
      </div>
      <div class="rounded-2xl border border-gray-100 bg-white/70 px-3 py-2 text-xs text-gray-700 flex items-center justify-between">
        <span>PubMed</span><span id="h_pubmed" class="px-2 py-0.5 rounded-full bg-gray-100">checando‚Ä¶</span>
      </div>
      <div class="rounded-2xl border border-gray-100 bg-white/70 px-3 py-2 text-xs text-gray-700 flex items-center justify-between">
        <span>DOAJ</span><span id="h_doaj" class="px-2 py-0.5 rounded-full bg-gray-100">checando‚Ä¶</span>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <aside class="lg:col-span-3 space-y-4">
      <div class="rounded-3xl border border-gray-100 bg-white/70 p-4 space-y-4">
        <div>
          <div class="mb-2 text-sm font-medium text-gray-700">Consulta</div>
          <div class="flex items-center gap-2">
            <input id="q" placeholder="Ex.: burnout enfermeiros (mindfulness OR TCC)" class="flex-1 rounded-2xl border border-gray-200 bg-white/70 px-3 py-2 text-sm" />
            <button id="btnSearch" class="rounded-2xl bg-indigo-600 text-white px-4 py-2 text-sm">Buscar</button>
          </div>
          <label class="text-xs text-gray-600 flex items-center gap-2 mt-2">
            Ordenar:
            <select id="orderBy" class="rounded-2xl border border-gray-200 bg-white/70 px-2 py-1 text-xs">
              <option value="score" selected>Melhor avalia√ß√£o</option>
              <option value="newest">Mais recentes</option>
              <option value="oldest">Mais antigos</option>
              <option value="title">T√≠tulo (A‚ÄìZ)</option>
            </select>
          </label>
        </div>

        <div>
          <div class="mb-2 text-sm font-medium text-gray-700">Per√≠odo (ano)</div>
          <div class="flex items-center gap-3">
            <input id="yearFrom" type="number" class="w-24 rounded-2xl border border-gray-200 px-3 py-1.5 text-sm" min="1990" max="2030" value="2019" />
            <span class="text-xs text-gray-500">‚Äî</span>
            <input id="yearTo" type="number" class="w-24 rounded-2xl border border-gray-200 px-3 py-1.5 text-sm" min="1990" max="2030" value="2025" />
          </div>
          <label class="mt-3 flex items-center gap-2 text-sm text-gray-700">
            <input id="oaOnly" type="checkbox" class="rounded border-gray-300" />
            Apenas Open Access (aprox.)
          </label>
        </div>

        <div>
          <div class="mb-2 text-sm font-medium text-gray-700">Idioma (filtragem local)</div>
          <div id="langFilters" class="flex flex-wrap gap-2 text-sm">
            <label class="flex items-center gap-1"><input type="checkbox" class="lang" value="en" checked> EN</label>
            <label class="flex items-center gap-1"><input type="checkbox" class="lang" value="pt" checked> PT</label>
            <label class="flex items-center gap-1"><input type="checkbox" class="lang" value="es" checked> ES</label>
            <label class="flex items-center gap-1"><input type="checkbox" class="lang" value="fr" checked> FR</label>
          </div>
        </div>

        <div>
          <div class="mb-2 text-sm font-medium text-gray-700">P√∫blico-alvo</div>
          <div class="flex flex-wrap gap-2 text-sm" id="popFilters">
            <label class="flex items-center gap-1"><input type="checkbox" class="pop" value="crianca" checked> Crian√ßa</label>
            <label class="flex items-center gap-1"><input type="checkbox" class="pop" value="adolescente" checked> Adolescente</label>
            <label class="flex items-center gap-1"><input type="checkbox" class="pop" value="jovem" checked> Jovem</label>
            <label class="flex items-center gap-1"><input type="checkbox" class="pop" value="adulto" checked> Adulto</label>
            <label class="flex items-center gap-1"><input type="checkbox" class="pop" value="idoso" checked> Idoso</label>
          </div>
          <button id="btnPopAll" class="mt-2 rounded-2xl bg-white text-gray-700 border border-gray-200 px-3 py-1.5 text-xs">Selecionar/Desmarcar todos</button>
          <div class="mt-1 text-[11px] text-gray-500">Filtro local ‚Äî n√£o altera a busca nas fontes.</div>
        </div>
      </div>

      <div class="rounded-3xl border border-gray-100 bg-white/70 p-4">
        <div class="text-sm font-medium text-gray-700 mb-2">Itens salvos</div>
        <div id="savedList" class="space-y-3 text-sm text-gray-700"></div>
      </div>
    </aside>

    <section class="lg:col-span-9 space-y-4">
      <div id="resultsHeader"></div>
      <div id="results" class="space-y-4"></div>
      <div id="pagination" class="flex items-center justify-center gap-2 mt-2"></div>
    </section>
  </main>

  <footer class="mx-auto max-w-6xl px-4 pb-10 text-xs text-gray-500">
    <div class="rounded-3xl bg-white/60 p-4 border border-gray-100">
      Preview ‚Ä¢ v0.6.5
    </div>
  </footer>

  <!-- Script: v0.6.5 (l√≥gica de busca intacta; adiciona apenas valida√ß√£o de PDFs) -->
  <script>
  (function(){
    function $(id){ return document.getElementById(id); }
    var h_crossref = $('h_crossref'), h_pubmed = $('h_pubmed'), h_doaj = $('h_doaj');
    var resultsEl = $('results'), qEl=$('q'), yearFromEl=$('yearFrom'), yearToEl=$('yearTo'), oaOnlyEl=$('oaOnly');
    var resultsHeader = $('resultsHeader'); var savedListEl = $('savedList');
    var orderByEl = $('orderBy'); var paginationEl = $('pagination');
    var LAST_RESULTS = []; var CURRENT_PAGE = 1; var PAGE_SIZE = 15;

    var THEME_KEY='psisearch_theme';
    function applyTheme(){ var t = localStorage.getItem(THEME_KEY) || 'light'; document.documentElement.classList.toggle('dark', t==='dark'); $('btnTheme').textContent = t==='dark' ? '‚òÄÔ∏è Modo claro' : 'üåô Modo escuro'; }
    applyTheme();
    $('btnTheme').addEventListener('click', function(){ var t = (localStorage.getItem(THEME_KEY) || 'light') === 'light' ? 'dark' : 'light'; localStorage.setItem(THEME_KEY, t); applyTheme(); });

    function setHealth(el, ok, label){ if(!el) return; if(ok){ el.textContent = label || 'online'; el.className = 'px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700'; } else { el.textContent = label || 'offline'; el.className = 'px-2 py-0.5 rounded-full bg-red-100 text-red-700'; } }
    function debounce(fn, ms){ var t; return function(){ var a=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(null,a); }, ms); } }
    function timeout(ms){ return new Promise(function(_,rej){ setTimeout(function(){ rej(new Error('timeout')); }, ms); }); }

    fetch('https://api.crossref.org/works?rows=0').then(function(r){ setHealth(h_crossref, r.ok, r.ok?'online':'HTTP '+r.status); }).catch(function(){ setHealth(h_crossref,false); });
    fetch('https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=cancer&retmode=json&retmax=1').then(function(r){ setHealth(h_pubmed, r.ok, r.ok?'online':'HTTP '+r.status); }).catch(function(){ setHealth(h_pubmed,false); });
    fetch('https://doaj.org/api/v2/search/articles/test?pageSize=1').then(function(r){ setHealth(h_doaj, r.ok, r.ok?'online':'HTTP '+r.status); }).catch(function(){ setHealth(h_doaj,false); });

    function cleanAbstract(a){ return String(a||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim(); }
    function normalizeTitle(s){ return String(s||'').toLowerCase().replace(/\s+/g,' ').trim(); }

    function classify(r){
      var t = ((r.title||'') + ' ' + (r.abstract||'') + ' ' + (r.type||'')).toLowerCase();
      if (/meta[- ]?analys|meta[- ]?an[a√°]lise/.test(t)) r.type = "Meta-an√°lise";
      else if (/systematic review|revis[a√£]o sistem[a√°]tica|\breview\b/.test(t)) r.type = "Revis√£o";
      else if (/randomi[sz]ed|ensaio|controlled trial|clinical trial/.test(t)) r.type = "Ensaio cl√≠nico";
      if (/qualitative|qualitativ[oa]/.test(t)) r.method = r.method || "Qualitativo";
      else if (/randomi[sz]ed|trial|quantitativ[oa]|meta-analys/.test(t)) r.method = r.method || "Quantitativo";
      else if (/mixed methods|m[e√©]todos mistos|misto/.test(t)) r.method = r.method || "Misto";
      if (/(\bchild(ren)?\b|infant|pediatric|crian[c√ß]a|infantil|pediatri)/.test(t)) r.population = "crianca";
      else if (/(adolescen|\bteen(ager)?s?\b|juvenil|youths?)/.test(t)) r.population = "adolescente";
      else if (/(\byoung adult(s)?\b|\bjovens?\b|juventude)/.test(t)) r.population = "jovem";
      else if (/(\badult(s)?\b|adulto[s]?)/.test(t)) r.population = "adulto";
      else if (/(older adult(s)?|elderly|aging|\baged\b|idoso[s]?)/.test(t)) r.population = "idoso";
      return r;
    }

    function dedup(items){
      var byKey = {}; items.forEach(function(r){
        var key = (r.doi||'').toLowerCase() || (normalizeTitle(r.title)+'|'+(r.year||''));
        if(!byKey[key]) byKey[key]=r;
        else{
          var prev=byKey[key];
          byKey[key]={
            id: prev.id||r.id, title:prev.title||r.title, authors:prev.authors&&prev.authors.length?prev.authors:r.authors,
            year:prev.year||r.year, journal:prev.journal||r.journal, doi:prev.doi||r.doi,
            abstract:prev.abstract||r.abstract, oa:prev.oa||r.oa, language:prev.language||r.language,
            url:prev.url||r.url, type: prev.type||r.type, method: prev.method||r.method, population: prev.population||r.population,
            pdf: prev.pdf || r.pdf,
            sources:Array.from(new Set([].concat(prev.sources||[], r.sources||[])))
          };
        }
      }); return Object.keys(byKey).map(function(k){return byKey[k];});
    }

    function fetchCrossref(q,y1,y2){
      var params=new URLSearchParams(); if(q) params.set('query',q); params.set('rows','20'); params.set('filter','from-pub-date:'+y1+'-01-01,until-pub-date:'+y2+'-12-31,type:journal-article');
      return fetch('https://api.crossref.org/works?'+params.toString())
        .then(function(r){ if(!r.ok) throw new Error('Crossref HTTP '+r.status); return r.json(); })
        .then(function(j){ var items=(j&&j.message&&j.message.items)||[]; return items.map(function(it){
            var doi=it.DOI||null; var title=Array.isArray(it.title)?it.title[0]:(it.title||''); var authors=Array.isArray(it.author)?it.author.map(function(a){return [a.family||'',a.given||''].filter(Boolean).join(', ');}):[];
            var year=(it.issued&&it.issued['date-parts']&&it.issued['date-parts'][0]&&it.issued['date-parts'][0][0])||null; var journal=Array.isArray(it['container-title'])?it['container-title'][0]:(it['container-title']||'');
            var abstract=cleanAbstract(it.abstract||''); var language=it.language||null; var url=it.URL||(doi?('https://doi.org/'+doi):null);
            var pdf=null; var links=Array.isArray(it.link)?it.link:[]; for (var i=0;i<links.length;i++){ var ct = String(links[i]['content-type']||''); if (ct.indexOf('pdf')>=0 && links[i].URL){ pdf = links[i].URL; break; } }
            var oa = !!pdf || (Array.isArray(it.link)&&it.link.some(function(l){return String(l['content-type']||'').indexOf('pdf')>=0;}));
            return classify({ id: doi||('crossref:'+Math.random()), title:title, authors:authors, year:year, journal:journal, doi:doi, abstract:abstract, oa:oa, language:language, url:url, pdf: pdf, sources:['Crossref'] });
        });});
    }

    function fetchPubMed(q,y1,y2){
      var date='("'+y1+'/01/01"[Date - Publication] : "'+y2+'/12/31"[Date - Publication])'; var term=q? (q+' AND '+date):date;
      var esURL='https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&retmode=json&retmax=20&sort=relevance&tool=psisearch&email=psisearch@example.com&term='+encodeURIComponent(term);
      return fetch(esURL).then(function(r){ if(!r.ok) throw new Error('PubMed esearch HTTP '+r.status); return r.json(); })
        .then(function(js){ var ids=(js&&js.esearchresult&&js.esearchresult.idlist)||[]; if(!ids.length) return [];
          var idStr=ids.slice(0,20).join(','); var sumURL='https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&retmode=json&tool=psisearch&email=psisearch@example.com&id='+idStr;
          return fetch(sumURL).then(function(r){ if(!r.ok) throw new Error('PubMed esummary HTTP '+r.status); return r.json(); })
            .then(function(ej){ var root=ej&&ej.result||{}; var uids=root.uids||[]; return uids.map(function(uid){ var it=root[uid]; if(!it) return null;
              var title=it.title||''; var authors=Array.isArray(it.authors)?it.authors.map(function(a){return a.name;}).filter(Boolean):[]; var journal=it.fulljournalname||it.source||'';
              var m=(it.pubdate||'').match(/(\d{4})/); var year=m?Number(m[1]):null; var doiEntry=Array.isArray(it.articleids)?it.articleids.find(function(a){return a.idtype==='doi';}):null; var doi=doiEntry?doiEntry.value:null;
              var langArr=Array.isArray(it.lang)?it.lang:[]; var langMap={eng:'en',por:'pt',spa:'es',fra:'fr'}; var language=langMap[langArr[0]]||langArr[0]||null;
              var url='https://pubmed.ncbi.nlm.nih.gov/'+uid+'/';
              var pmc = Array.isArray(it.articleids)?it.articleids.find(function(a){return a.idtype==='pmcid';}):null;
              // Tente duas variantes de PDF
              var pdf = pmc ? ('https://www.ncbi.nlm.nih.gov/pmc/articles/'+pmc.value+'/pdf/') : null;
              return classify({ id: doi||('pubmed:'+uid), title:title, authors:authors, year:year, journal:journal, doi:doi, abstract:'', oa:false, language:language, url:url, pdf: pdf, sources:['PubMed'] });
            }).filter(Boolean); });
        });
    }

    function fetchDOAJ(q,y1,y2){
      function esc(s){ return s.replace(/([+\-!(){}\[\]^"~*?:\\/])/g, "\\$1"); }
      var parts=[]; if(q) parts.push('('+esc(q)+')'); parts.push('bibjson.year:['+y1+' TO '+y2+']'); var query=parts.join(' AND ');
      var url='https://doaj.org/api/v2/search/articles/'+encodeURIComponent(query)+'?pageSize=20';
      return fetch(url).then(function(r){ if(!r.ok) throw new Error('DOAJ HTTP '+r.status); return r.json(); })
        .then(function(j){ var arr=Array.isArray(j&&j.results)?j.results:[]; return arr.map(function(it){ var b=it&&it.bibjson||{};
          var title=b.title||''; var authors=Array.isArray(b.author)?b.author.map(function(a){return a.name;}).filter(Boolean):[]; var year=Number(b.year)||null;
          var journal=(b.journal&&b.journal.title)||''; var doiEntry=Array.isArray(b.identifier)?b.identifier.find(function(x){return (x.type||'').toLowerCase()==='doi';}):null; var doi=doiEntry?doiEntry.id:null;
          var abstract=b.abstract||''; var lang=(b.journal&&b.journal.language&&b.journal.language[0])||b.language||null; var language=Array.isArray(lang)?(lang[0]||null):lang;
          var link=Array.isArray(b.link)?(((b.link.find(function(l){return (l.type||'').toLowerCase().indexOf('full')>=0;})||{}).url) || (b.link[0]&&b.link[0].url) || null):null;
          var pdf=null; if(Array.isArray(b.link)){ for(var i=0;i<b.link.length;i++){ var u=b.link[i].url||''; if(/\.pdf(\?|$)/i.test(u) || /\/pdf(\?|$)/i.test(u)){ pdf=u; break; } } }
          return classify({ id: doi||('doaj:'+it.id), title:title, authors:authors, year:year, journal:journal, doi:doi, abstract:abstract, oa:true, language:language, url:link, pdf: pdf, sources:['DOAJ'] });
        });});
    }

    // ===== Valida√ß√£o de PDF (best-effort) =====
    function pmcVariants(url){
      var m = url && url.match(/\/pmc\/articles\/(PMC\d+)\/pdf\/?$/i);
      if(!m) return [url].filter(Boolean);
      var id = m[1];
      return [
        'https://www.ncbi.nlm.nih.gov/pmc/articles/'+id+'/pdf/',
        'https://www.ncbi.nlm.nih.gov/pmc/articles/'+id+'/pdf/'+id+'.pdf'
      ];
    }

    function fetchHead(url, opts){ return fetch(url, Object.assign({ method:'HEAD' }, opts||{})); }
    function fetchRange(url, opts){ return fetch(url, Object.assign({ method:'GET', headers:{'Range':'bytes=0-0'} }, opts||{})); }

    async function validatePdfUrl(url){
      if(!url) return false;
      var tries = pmcVariants(url);
      for (var i=0;i<tries.length;i++){
        var u = tries[i];
        try {
          var res = await Promise.race([fetchHead(u), timeout(5000)]);
          if (res && (res.status===200 || res.status===206)) return u;
          if (res && (res.status===405 || res.status===403 || res.status===0)) {
            // Tenta GET com Range (alguns hosts n√£o aceitam HEAD / CORS)
            var res2 = await Promise.race([fetchRange(u), timeout(7000)]);
            if (res2 && (res2.ok || res2.status===206)) return u;
          }
          if (res && res.status===200) return u;
        } catch(e){
          // ignora e tenta pr√≥ximo
        }
      }
      return false;
    }

    function enhancePdfButtons(scope){
      var container = scope || document;
      var buttons = container.querySelectorAll('button[data-pdf]');
      buttons.forEach(function(btn){
        var url = btn.getAttribute('data-pdf');
        if(!url){ btn.disabled = true; btn.title = 'PDF indispon√≠vel'; return; }
        btn.disabled = true;
        btn.textContent = 'PDF (checando‚Ä¶)';
        validatePdfUrl(url).then(function(validUrl){
          if(validUrl){
            btn.disabled = false;
            btn.textContent = 'PDF';
            btn.title = 'Abrir PDF';
            btn.addEventListener('click', function(){
              window.open(validUrl, '_blank', 'noopener');
            }, { once:true });
          } else {
            btn.disabled = true;
            btn.textContent = 'PDF';
            btn.title = 'PDF n√£o encontrado (404)';
          }
        }).catch(function(){
          btn.disabled = true;
          btn.textContent = 'PDF';
          btn.title = 'N√£o foi poss√≠vel validar o PDF';
        });
      });
    }
    // =========================================

    var STORAGE_KEY='psisearch_saved_v1';
    function loadSaved(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e){ return []; } }
    function saveSaved(items){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }
    function bibtex(item){ var authors=(item.authors||[]).join(' and '); var key=((item.authors&&item.authors[0]&&item.authors[0].split(' ')[0])||'ref').toLowerCase()+(item.year||''); return '@article{'+key+',\n  title={'+(item.title||'')+'},\n  author={'+authors+'},\n  journal={'+(item.journal||'')+'},\n  year={'+(item.year||'')+'},\n  doi={'+(item.doi||'')+'}\n}'; }
    function renderSaved(){ var saved = loadSaved(); if(saved.length===0){ savedListEl.innerHTML='<div class="text-gray-500">Nada salvo ainda.</div>'; return; }
      savedListEl.innerHTML = saved.map(function(s){ return '<div class="flex items-start justify-between gap-3"><div><div class="text-sm font-medium text-gray-800 line-clamp-2">'+(s.title||'')+'</div><div class="text-xs text-gray-500">'+(((s.authors||[])[0])||'')+' et al., '+(s.year||'')+'</div></div><div class="flex gap-2"><button class="rounded-2xl border border-gray-200 px-3 py-1 text-xs" data-action="copy" data-id="'+s.id+'">BibTeX</button><button class="rounded-2xl border border-gray-200 px-3 py-1 text-xs" data-action="remove" data-id="'+s.id+'">Remover</button></div></div>'; }).join(''); }

    function readParams(){ var p = new URLSearchParams(location.search); if (p.get('q')) $('q').value = p.get('q'); if (p.get('y1')) $('yearFrom').value = p.get('y1'); if (p.get('y2')) $('yearTo').value = p.get('y2'); var order = p.get('ord'); if(order) orderByEl.value = order; var pops = p.get('pops'); if (pops){ var set = {}; pops.split(',').forEach(function(x){ set[x]=true; }); document.querySelectorAll('.pop').forEach(function(el){ el.checked = !!set[el.value]; }); } }
    function writeParams(){ var p = new URLSearchParams(location.search); p.set('q', $('q').value || ''); p.set('y1', $('yearFrom').value || '2019'); p.set('y2', $('yearTo').value || '2025'); p.set('ord', orderByEl.value); var pops = Array.from(document.querySelectorAll('.pop:checked')).map(function(el){return el.value;}).join(','); p.set('pops', pops); history.replaceState(null, '', '?' + p.toString()); }

    function scoreOf(r,y1,y2){ var s=0; if(r.type==='Meta-an√°lise') s+=10; else if(r.type==='Revis√£o') s+=6; else if(r.type==='Ensaio cl√≠nico') s+=4; if(r.oa) s+=2; if(r.doi) s+=1; if(r.abstract && r.abstract.length>120) s+=1; if(r.year){ var span=Math.max(1,(y2-y1+1)); var norm=Math.min(1,Math.max(0,(r.year-y1)/span)); s+=3*norm; } if((r.sources||[]).indexOf('PubMed')>=0) s+=1; if((r.sources||[]).indexOf('DOAJ')>=0) s+=0.5; return s; }
    function sortResults(arr,y1,y2,mode){ var a=arr.slice(); if(mode==='newest'){ a.sort(function(x,y){return (y.year||0)-(x.year||0);}); } else if(mode==='oldest'){ a.sort(function(x,y){return (x.year||0)-(y.year||0);}); } else if(mode==='title'){ a.sort(function(x,y){return String(x.title||'').localeCompare(String(y.title||''));}); } else { a.forEach(function(r){ r.score=scoreOf(r,y1,y2); }); a.sort(function(x,y){return (y.score||0)-(x.score||0);}); } return a; }

    function renderPagination(total,page,pageSize){ var pages=Math.max(1,Math.ceil(total/pageSize)); if(pages<=1){ paginationEl.innerHTML=''; return; } var disablePrev=page<=1; var disableNext=page>=pages; paginationEl.innerHTML=''+'<button id="pgFirst" class="rounded-2xl border border-gray-200 px-3 py-1 text-sm bg-white" '+(disablePrev?'disabled':'')+'>¬´ Primeiro</button>'+'<button id="pgPrev" class="rounded-2xl border border-gray-200 px-3 py-1 text-sm bg-white" '+(disablePrev?'disabled':'')+'>‚Äπ Anterior</button>'+'<span class="text-sm text-gray-700">P√°gina '+page+' de '+pages+'</span>'+'<button id="pgNext" class="rounded-2xl border border-gray-200 px-3 py-1 text-sm bg-white" '+(disableNext?'disabled':'')+'>Pr√≥xima ‚Ä∫</button>'+'<button id="pgLast" class="rounded-2xl border border-gray-200 px-3 py-1 text-sm bg-white" '+(disableNext?'disabled':'')+'>√öltima ¬ª</button>'; $('pgFirst').onclick=function(){CURRENT_PAGE=1;renderResults();}; $('pgPrev').onclick=function(){ if(CURRENT_PAGE>1){CURRENT_PAGE--;renderResults();} }; $('pgNext').onclick=function(){ var pages=Math.ceil(LAST_RESULTS.length/PAGE_SIZE); if(CURRENT_PAGE<pages){CURRENT_PAGE++;renderResults();} }; $('pgLast').onclick=function(){ CURRENT_PAGE=Math.ceil(LAST_RESULTS.length/PAGE_SIZE); renderResults(); };
    }

    function actionButtons(item, href){
      var openBtn = '<a class="btn" href="'+href+'" target="_blank" rel="noopener">Abrir artigo</a>';
      var pdfBtn  = '<button class="btn-solid" data-pdf="'+(item.pdf||'')+'" title="PDF">PDF</button>';
      return openBtn + ' ' + pdfBtn;
    }

    function renderResults(){
      var total=LAST_RESULTS.length;
      renderPagination(total,CURRENT_PAGE,PAGE_SIZE);
      var start=(CURRENT_PAGE-1)*PAGE_SIZE;
      var pageItems=LAST_RESULTS.slice(start,start+PAGE_SIZE);
      resultsEl.innerHTML=pageItems.map(function(item){
        var href=item.url?item.url:(item.doi?('https://doi.org/'+item.doi):'#');
        var chips='';
        if(item.type) chips+='<span class="inline-flex items-center rounded-full border border-gray-200 bg-white/70 px-2.5 py-1 text-xs text-gray-700">'+item.type+'</span>';
        if(item.method) chips+='<span class="inline-flex items-center rounded-full border border-gray-200 bg-white/70 px-2.5 py-1 text-xs text-gray-700">'+item.method+'</span>';
        if(item.population){ var label={crianca:'Crian√ßa',adolescente:'Adolescente',jovem:'Jovem',adulto:'Adulto',idoso:'Idoso'}[item.population]||item.population; chips+='<span class="inline-flex items-center rounded-full border border-gray-200 bg-white/70 px-2.5 py-1 text-xs text-gray-700">'+label+'</span>'; }
        if(item.language) chips+='<span class="inline-flex items-center rounded-full border border-gray-200 bg-white/70 px-2.5 py-1 text-xs text-gray-700">'+String(item.language).toUpperCase()+'</span>';
        if(item.oa) chips+='<span class="inline-flex items-center rounded-full border border-emerald-200 bg-white/70 px-2.5 py-1 text-xs text-emerald-700">Open Access</span>';
        if(typeof item.score==='number') chips+='<span class="inline-flex items-center rounded-full border border-gray-200 bg-white/70 px-2.5 py-1 text-xs text-gray-700">Score: '+item.score.toFixed(1)+'</span>';

        return '<div class="rounded-3xl border border-gray-100 bg-white/70 p-5">'+
            '<a href="'+href+'" target="_blank" class="group inline-flex items-start gap-2"><h3 class="text-base font-semibold leading-snug text-gray-800 group-hover:text-indigo-400">'+(item.title||'(sem t√≠tulo)')+'</h3><span class="text-gray-400">‚Üó</span></a>'+
            '<div class="text-sm text-gray-600">'+(item.authors||[]).join(', ')+' ‚Ä¢ '+(item.journal||'')+' ‚Ä¢ '+(item.year||'')+'</div>'+
            '<div class="flex flex-wrap gap-2 text-xs mt-2">'+chips+'</div>'+
            '<div class="mt-3 flex items-center gap-2">'+actionButtons(item, href)+'</div>'+
            '<div class="mt-2 text-xs text-gray-500">Fonte: '+((item.sources||[]).join(', ') || '‚Äî')+' ‚Ä¢ DOI: '+(item.doi || '‚Äî')+'</div>'+
          '</div>';
      }).join('');

      // Ap√≥s render, validar bot√µes PDF na p√°gina atual
      enhancePdfButtons(resultsEl);
    }

    function readLangSet(){ var c=document.querySelectorAll('.lang:checked'); var s={}; for(var i=0;i<c.length;i++) s[String(c[i].value).toLowerCase()]=true; return s; }

    function search(){
      writeParams();
      var q=(qEl.value||'').trim(); var y1=Number(yearFromEl.value)||2019; var y2=Number(yearToEl.value)||2025;
      var langSet=readLangSet(); var oaOnly=oaOnlyEl.checked;
      var popSel=Array.from(document.querySelectorAll('.pop:checked')).map(function(el){return el.value;});
      var usePopFilter=popSel.length>0 && popSel.length<5;

      resultsHeader.innerHTML='<div class="rounded-2xl border border-gray-100 bg-white/60 p-3 text-xs text-gray-600 mb-2">Buscando‚Ä¶</div>';
      resultsEl.innerHTML=''; paginationEl.innerHTML='';

      Promise.allSettled([fetchCrossref(q,y1,y2), fetchPubMed(q,y1,y2), fetchDOAJ(q,y1,y2)]).then(function(res){
        var arr=[], errors={};
        if(res[0].status==='fulfilled') arr=arr.concat(res[0].value); else errors.crossref=String(res[0].reason);
        if(res[1].status==='fulfilled') arr=arr.concat(res[1].value); else errors.pubmed=String(res[1].reason);
        if(res[2].status==='fulfilled') arr=arr.concat(res[2].value); else errors.doaj=String(res[2].reason);

        var merged=dedup(arr).filter(function(r){
          var byLang=(!r.language || langSet[String(r.language).toLowerCase()] || Object.keys(langSet).length===0);
          var byOA=(!oaOnly || !!r.oa);
          var byPop=(!usePopFilter || (r.population && popSel.indexOf(r.population) >= 0));
          return byLang && byOA && byPop;
        });

        var mode=orderByEl.value || 'score';
        LAST_RESULTS=sortResults(merged,y1,y2,mode);
        CURRENT_PAGE=1;

        var header='<div class="rounded-2xl border border-gray-100 bg-white/60 p-3 text-xs text-gray-600 mb-2"><span class="font-medium">Resultados:</span> '+LAST_RESULTS.length+(Object.keys(errors).length? ' ‚Ä¢ <span class="text-red-600">Erros: '+Object.keys(errors).join(', ')+'</span>':'')+'</div>';
        resultsHeader.innerHTML=header;

        if(!LAST_RESULTS.length){
          resultsEl.innerHTML='<div class="rounded-3xl border border-gray-100 bg-white/70 p-6 text-center text-gray-600">Nenhum resultado.</div>';
          return;
        }
        renderResults();
      }).catch(function(err){
        resultsHeader.innerHTML='';
        resultsEl.innerHTML='<div class="rounded-3xl border border-red-100 bg-red-50 p-6 text-sm text-red-700">Erro ao buscar: '+String(err && err.message || err)+'</div>';
      });
    }

    document.getElementById('btnSearch').addEventListener('click', search);
    var searchDebounced = debounce(search, 350);
    qEl.addEventListener('input', searchDebounced);
    yearFromEl.addEventListener('change', search);
    yearToEl.addEventListener('change', search);
    oaOnlyEl.addEventListener('change', search);
    document.getElementById('popFilters').addEventListener('change', search);
    document.getElementById('btnPopAll').addEventListener('click', function(){ var boxes=Array.from(document.querySelectorAll('.pop')); var allChecked=boxes.every(function(b){return b.checked;}); boxes.forEach(function(b){ b.checked=!allChecked; }); search(); });
    orderByEl.addEventListener('change', function(){ writeParams(); var y1=Number(yearFromEl.value)||2019; var y2=Number(yearToEl.value)||2025; LAST_RESULTS=sortResults(LAST_RESULTS,y1,y2,orderByEl.value); CURRENT_PAGE=1; renderResults(); });

    (function(){ var p=new URLSearchParams(location.search); if(p.get('q')) $('q').value=p.get('q'); if(p.get('y1')) $('yearFrom').value=p.get('y1'); if(p.get('y2')) $('yearTo').value=p.get('y2'); var order=p.get('ord'); if(order) orderByEl.value=order; var pops=p.get('pops'); if(pops){ var set={}; pops.split(',').forEach(function(x){set[x]=true;}); document.querySelectorAll('.pop').forEach(function(el){ el.checked=!!set[el.value]; }); } })();

    if ((qEl.value||'').trim()) search();
    setHealth(h_crossref, true, 'JS carregou');
  })();
  </script>
</body>
</html>
